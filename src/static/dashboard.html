<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace Project Dashboard</title>
    <link rel="stylesheet" href="/dashboard/style.css">
    <!-- Chart.js will be loaded dynamically -->
    <!-- Monaco Editor CDN -->
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Workspace Project Dashboard</h1>
            <div class="status-indicators">
                <div class="status-item">
                    <span class="status-label">Server</span>
                    <span class="status-value online">Online</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Updated</span>
                    <span class="status-value" id="last-updated">--</span>
                </div>
            </div>
        </header>

        <main>
            <div class="dashboard-grid">
                <!-- Project Overview -->
                <section class="card overview">
                    <h2>Project Overview</h2>
                    <div class="project-info">
                        <div class="project-name" id="project-name">Loading...</div>
                        <div class="project-description" id="project-description">--</div>
                    </div>
                </section>

                <!-- Feature Metrics -->
                <section class="card metrics">
                    <h2>Feature Progress</h2>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value" id="total-features">--</div>
                            <div class="metric-label">Total Features</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="implemented-features">--</div>
                            <div class="metric-label">Implemented</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="tested-features">--</div>
                            <div class="metric-label">Tested</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="implementation-percentage">--%</div>
                            <div class="metric-label">Implementation</div>
                        </div>
                    </div>
                    <div class="progress-bars">
                        <div class="progress-bar">
                            <label>Implementation Progress</label>
                            <div class="bar">
                                <div class="fill implementation" id="implementation-bar"></div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <label>Test Coverage</label>
                            <div class="bar">
                                <div class="fill testing" id="testing-bar"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Task Summary -->
                <section class="card tasks">
                    <h2>Task Summary</h2>
                    <div class="task-stats">
                        <div class="task-stat pending">
                            <div class="count" id="pending-tasks">--</div>
                            <div class="label">Pending</div>
                        </div>
                        <div class="task-stat progress">
                            <div class="count" id="progress-tasks">--</div>
                            <div class="label">In Progress</div>
                        </div>
                        <div class="task-stat completed">
                            <div class="count" id="completed-tasks">--</div>
                            <div class="label">Completed</div>
                        </div>
                        <div class="task-stat blocked">
                            <div class="count" id="blocked-tasks">--</div>
                            <div class="label">Blocked</div>
                        </div>
                    </div>
                </section>

                <!-- Feature Status Charts -->
                <section class="card feature-charts">
                    <h2>Feature Status Visualization</h2>
                    <div class="charts-container">
                        <div class="chart-section">
                            <h3>Implementation Status</h3>
                            <canvas id="feature-status-chart" width="300" height="300"></canvas>
                        </div>
                        <div class="chart-section">
                            <h3>Progress Distribution</h3>
                            <canvas id="feature-progress-chart" width="300" height="200"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Feature List -->
                <section class="card feature-list">
                    <h2>Recent Features</h2>
                    <div class="feature-controls">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="pending">Pending</button>
                        <button class="filter-btn" data-filter="implemented">Implemented</button>
                        <button class="filter-btn" data-filter="tested">Tested</button>
                    </div>
                    <div class="feature-items" id="feature-list">
                        <div class="loading">Loading features...</div>
                    </div>
                </section>

                <!-- Task List -->
                <section class="card task-list">
                    <h2>Active Tasks</h2>
                    <div class="task-controls">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="pending">Pending</button>
                        <button class="filter-btn" data-filter="in_progress">In Progress</button>
                        <button class="filter-btn" data-filter="blocked">Blocked</button>
                    </div>
                    <div class="task-items" id="task-list">
                        <div class="loading">Loading tasks...</div>
                    </div>
                </section>

                <!-- Directive List -->
                <section class="card directive-list">
                    <h2>Project Directives</h2>
                    <div class="directive-controls">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="development">Development</button>
                        <button class="filter-btn" data-filter="security">Security</button>
                        <button class="filter-btn" data-filter="testing">Testing</button>
                    </div>
                    <div class="directive-items" id="directive-list">
                        <div class="loading">Loading directives...</div>
                    </div>
                </section>

                <!-- Entity Relationships -->
                <section class="card relationship-list">
                    <h2>Entity Relationships</h2>
                    <div class="relationship-controls">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="implements">Implements</button>
                        <button class="filter-btn" data-filter="depends_on">Depends On</button>
                        <button class="filter-btn" data-filter="blocks">Blocks</button>
                        <button class="filter-btn" data-filter="worked_in">Worked In</button>
                    </div>
                    <div class="relationship-items" id="relationship-list">
                        <div class="loading">Loading relationships...</div>
                    </div>
                </section>

                <!-- Milestones -->
                <section class="card milestones">
                    <h2>Project Milestones</h2>
                    <div class="milestone-filters">
                        <button class="filter-btn active" data-filter="all">All Milestones</button>
                        <button class="filter-btn" data-filter="planned">Planned</button>
                        <button class="filter-btn" data-filter="in_progress">In Progress</button>
                        <button class="filter-btn" data-filter="achieved">Achieved</button>
                    </div>
                    <div class="milestone-items" id="milestone-list">
                        <div class="loading">Loading milestones...</div>
                    </div>
                </section>

                <!-- Notes -->
                <section class="card notes">
                    <h2>Project Notes</h2>
                    <div class="note-search">
                        <input type="text" id="note-search-input" placeholder="Search notes by content or title..." onkeyup="searchNotes()" />
                        <button id="clear-search" onclick="clearNoteSearch()" style="display: none;">Clear</button>
                    </div>
                    <div class="note-controls">
                        <button class="filter-btn active" data-filter="all">All Notes</button>
                        <button class="filter-btn" data-filter="Architecture">Architecture</button>
                        <button class="filter-btn" data-filter="Decision">Decision</button>
                        <button class="filter-btn" data-filter="Reminder">Reminder</button>
                        <button class="filter-btn" data-filter="Observation">Observation</button>
                        <button class="btn btn-primary" onclick="showAddNoteDialog()">Add Note</button>
                        <button class="btn btn-secondary" onclick="showProjectNoteDialog()">Add Project-wide Note</button>
                    </div>
                    <div class="note-items" id="note-list">
                        <div class="loading">Loading notes...</div>
                    </div>
                </section>

                <!-- Note Links -->
                <section class="card note-links">
                    <h2>Note Links</h2>
                    <div class="note-link-controls">
                        <button class="filter-btn active" data-filter="all">All Links</button>
                        <button class="filter-btn" data-filter="reference">References</button>
                        <button class="filter-btn" data-filter="related">Related</button>
                        <button class="filter-btn" data-filter="blocks">Blocks</button>
                        <button class="filter-btn" data-filter="auto">Auto-Detected</button>
                    </div>
                    <div class="note-link-items" id="note-link-list">
                        <div class="loading">Loading note links...</div>
                    </div>
                </section>

                <!-- Recent Activity -->
                <section class="card activity">
                    <h2>Recent Activity</h2>
                    <div class="activity-list" id="activity-list">
                        <div class="loading">Loading activity...</div>
                    </div>
                </section>

                <!-- Git Timeline and File Browser -->
                <section class="card timeline full-width" style="grid-column: 1 / -1;">
                    <h2>Project Timeline & File Browser</h2>
                    <div class="timeline-controls">
                        <button id="timeline-btn" class="tab-btn active">Timeline</button>
                        <button id="files-btn" class="tab-btn">Files</button>
                        <button id="commits-btn" class="tab-btn">Commits</button>
                    </div>
                    
                    <div id="timeline-view" class="timeline-content">
                        <div class="timeline-list" id="timeline-list">
                            <div class="loading">Loading timeline...</div>
                        </div>
                    </div>
                    
                    <div id="files-view" class="files-content" style="display: none;">
                        <div class="files-browser">
                            <div class="files-sidebar">
                                <div class="commit-selector">
                                    <label for="commit-select">Browse at commit:</label>
                                    <select id="commit-select">
                                        <option value="HEAD">Latest (HEAD)</option>
                                    </select>
                                </div>
                                <div class="file-tree" id="file-tree">
                                    <div class="loading">Loading files...</div>
                                </div>
                            </div>
                            <div class="file-viewer">
                                <div class="file-header">
                                    <span id="current-file-path">Select a file to view</span>
                                    <div class="file-actions">
                                        <button id="show-diff-btn" disabled>Show Diff</button>
                                    </div>
                                </div>
                                <div id="monaco-container" style="height: 600px; border: 1px solid #ccc;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="commits-view" class="commits-content" style="display: none;">
                        <div class="commits-list" id="commits-list">
                            <div class="loading">Loading commits...</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Diff Modal -->
    <div id="diff-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>File Diff</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="diff-container" style="height: 500px;"></div>
            </div>
        </div>
    </div>

    <!-- Add Note Dialog -->
    <div id="add-note-dialog" class="floating-dialog" style="display: none;">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3 id="add-note-title">Add Project Note</h3>
                <button class="dialog-close" onclick="closeAddNoteDialog()">&times;</button>
            </div>
            <div class="dialog-body">
                <form id="add-note-form" onsubmit="submitNote(event)">
                    <div class="form-row">
                        <label for="note-title">Title:</label>
                        <input type="text" id="note-title" name="title" required>
                    </div>
                    <div class="form-row">
                        <label for="note-type">Type:</label>
                        <select id="note-type" name="note_type" required>
                            <option value="Architecture">Architecture</option>
                            <option value="Decision">Decision</option>
                            <option value="Reminder">Reminder</option>
                            <option value="Observation">Observation</option>
                            <option value="Reference">Reference</option>
                            <option value="Evidence">Evidence</option>
                            <option value="Progress">Progress</option>
                            <option value="Issue">Issue</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="note-content">Content:</label>
                        <textarea id="note-content" name="content" rows="6" required></textarea>
                    </div>
                    <div class="form-row" id="entity-selection" style="display: none;">
                        <label for="entity-type">Attach to Entity:</label>
                        <select id="entity-type" name="entity_type">
                            <option value="">None (Project-wide note)</option>
                            <option value="Feature">Feature</option>
                            <option value="Task">Task</option>
                            <option value="Session">Session</option>
                            <option value="Milestone">Milestone</option>
                        </select>
                    </div>
                    <div class="form-row" id="entity-id-row" style="display: none;">
                        <label for="entity-id">Entity ID:</label>
                        <input type="text" id="entity-id" name="entity_id" placeholder="e.g., F0001, task-123">
                    </div>
                    <div class="dialog-actions">
                        <button type="button" onclick="closeAddNoteDialog()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Note</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- F0146: Use local Chart.js for better headless compatibility -->
    <script src="/dashboard/chart.min.js"></script>
    <script>
        console.log('After Chart.js load - Chart available:', typeof Chart !== 'undefined');
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js version:', Chart.version);
            // Test Chart.js functionality with dummy canvas
            try {
                const testCanvas = document.createElement('canvas');
                const testCtx = testCanvas.getContext('2d');
                const testChart = new Chart(testCtx, {type: 'doughnut', data: {datasets: [{data: [1]}]}});
                testChart.destroy();
                console.log('Chart.js functionality test: PASSED');
                window.chartJsWorking = true;
            } catch (error) {
                console.log('Chart.js functionality test: FAILED', error);
                window.chartJsWorking = false;
            }
        } else {
            console.log('Chart.js not available');
            window.chartJsWorking = false;
        }
    </script>
    <script src="/dashboard/app.js?v=27"></script>
</body>
</html>